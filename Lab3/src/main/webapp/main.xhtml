<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <meta charset="UTF-8"/>
    <title>Лабораторная работа №3</title>
    <h:outputStylesheet name="css/style.css"/>
    <h:outputScript name="js/app.js" target="body"/>
</h:head>
<h:body style="background: url('resources/images/fzt2.gif') center/cover no-repeat fixed;">
    <div style="position: fixed; inset: 0; background: radial-gradient(140% 100% at 50% 0%, rgba(34,197,94,0.3), rgba(15,23,42,0.95)); z-index: -1;"></div>

    <div class="container">
        <header class="header">
            <div class="title">Абрамова Анастасия Сергеевна</div>
            <div class="subtitle">Группа: P3211 • Вариант: 3</div>
        </header>

        <h:form id="main-form">
            <h:messages id="messages"
                        globalOnly="false"
                        styleClass="messages-container"
                        errorClass="error-message"
                        warnClass="warn-message"
                        infoClass="info-message"
                        showDetail="true"
                        showSummary="false"/>

            <div class="grid">
                <div class="card">
                    <h2>Ввод данных</h2>
                    <div class="form">
                        <!-- X -->
                        <div class="form-row">
                            <h:outputLabel for="x-select" value="X:"/>
                            <div style="width: 100%;">
                                <h:selectOneMenu id="x-select"
                                                 value="#{resultsManager.newResult.x}"
                                                 styleClass="form-control"
                                                 required="true"
                                                 requiredMessage="Выберите значение X из списка">
                                    <f:selectItem itemLabel="Выберите X" itemValue="#{null}" noSelectionOption="true"/>
                                    <f:selectItem itemLabel="-2" itemValue="-2.0"/>
                                    <f:selectItem itemLabel="-1.5" itemValue="-1.5"/>
                                    <f:selectItem itemLabel="-1" itemValue="-1.0"/>
                                    <f:selectItem itemLabel="-0.5" itemValue="-0.5"/>
                                    <f:selectItem itemLabel="0" itemValue="0.0"/>
                                    <f:selectItem itemLabel="0.5" itemValue="0.5"/>
                                    <f:selectItem itemLabel="1" itemValue="1.0"/>
                                    <f:selectItem itemLabel="1.5" itemValue="1.5"/>
                                    <f:selectItem itemLabel="2" itemValue="2.0"/>
                                </h:selectOneMenu>
                                <h:message for="x-select" styleClass="field-error"/>
                            </div>
                        </div>

                        <!-- Y -->
                        <div class="form-row">
                            <h:outputLabel for="y-input" value="Y:"/>
                            <div style="width: 100%;">
                                <h:inputText id="y-input"
                                             value="#{resultsManager.newResult.y}"
                                             styleClass="form-control"
                                             placeholder="(-5 ... 5)"
                                             maxlength="10"
                                             required="true"
                                             requiredMessage="Введите значение Y в диапазоне (-5; 5)">
                                    <f:validator validatorId="yValidator"/>
                                </h:inputText>
                                <h:message for="y-input" styleClass="field-error"/>
                            </div>
                        </div>

                        <!-- R -->
                        <div class="form-row">
                            <h:outputLabel value="R:"/>
                            <div style="width: 100%;">
                                <h:panelGroup id="r-links">
                                    <h:commandLink value="1" styleClass="r-link #{resultsManager.newResult.r == 1.0 ? 'active' : ''}">
                                        <f:setPropertyActionListener target="#{resultsManager.newResult.r}" value="1.0"/>
                                        <f:ajax execute="@this" render="graph r-links r-value"/>
                                    </h:commandLink>
                                    <h:commandLink value="2" styleClass="r-link #{resultsManager.newResult.r == 2.0 ? 'active' : ''}">
                                        <f:setPropertyActionListener target="#{resultsManager.newResult.r}" value="2.0"/>
                                        <f:ajax execute="@this" render="graph r-links r-value"/>
                                    </h:commandLink>
                                    <h:commandLink value="3" styleClass="r-link #{resultsManager.newResult.r == 3.0 ? 'active' : ''}">
                                        <f:setPropertyActionListener target="#{resultsManager.newResult.r}" value="3.0"/>
                                        <f:ajax execute="@this" render="graph r-links r-value"/>
                                    </h:commandLink>
                                    <h:commandLink value="4" styleClass="r-link #{resultsManager.newResult.r == 4.0 ? 'active' : ''}">
                                        <f:setPropertyActionListener target="#{resultsManager.newResult.r}" value="4.0"/>
                                        <f:ajax execute="@this" render="graph r-links r-value"/>
                                    </h:commandLink>
                                    <h:commandLink value="5" styleClass="r-link #{resultsManager.newResult.r == 5.0 ? 'active' : ''}">
                                        <f:setPropertyActionListener target="#{resultsManager.newResult.r}" value="5.0"/>
                                        <f:ajax execute="@this" render="graph r-links r-value"/>
                                    </h:commandLink>

                                    <h:inputHidden id="r-hidden" value="#{resultsManager.newResult.r}"/>
                                    <h:outputText id="r-value" value=" (выбрано: #{resultsManager.newResult.r != null ? resultsManager.newResult.r : 'не выбрано'})" style="margin-left:10px; color:var(--muted); font-size:0.9rem;"/>
                                </h:panelGroup>
                            </div>
                        </div>

                        <!-- Теги -->
                        <div class="form-row">
                            <h:outputLabel for="tags-input" value="Теги:"/>
                            <div style="width:100%;">
                                <h:inputText id="tags-input"
                                             value="#{resultsManager.newResult.tagsString}"
                                             styleClass="form-control"
                                             placeholder="через запятую (опционально)"/>
                                <h:message for="tags-input" styleClass="field-error"/>
                            </div>
                        </div>

                        <div class="form-actions">
                            <h:commandButton value="Проверить"
                                             action="#{resultsManager.addResultFromForm()}"
                                             styleClass="btn primary">
                                <f:ajax execute="@form" render="@form results-table graph"/>
                            </h:commandButton>

                            <h:commandButton value="Очистить"
                                             action="#{resultsManager.clearResults()}"
                                             styleClass="btn"
                                             immediate="true">
                                <f:ajax execute="@this" render="@form results-table graph"/>
                            </h:commandButton>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>График</h2>
                    <h:panelGroup id="graph" layout="block" styleClass="graph-wrap">
                        <svg id="graph-svg" width="320" height="320" viewBox="0 0 320 320" preserveAspectRatio="xMidYMid meet" onclick="handleGraphClick(event)">
                            <defs>
                                <clipPath id="graph-clip">
                                    <rect x="0" y="0" width="320" height="320" rx="12" ry="12"/>
                                </clipPath>
                            </defs>

                            <ui:param name="r" value="#{resultsManager.newResult.r != null ? resultsManager.newResult.r : 1.0}"/>
                            <ui:param name="scale" value="#{resultsManager.scale != null ? resultsManager.scale : 40}"/>
                            <ui:param name="centerX" value="160"/>
                            <ui:param name="centerY" value="160"/>

                            <g clip-path="url(#graph-clip)">
                                <g stroke="#1f2937" stroke-width="0.5" opacity="0.3">
                                    <ui:repeat value="#{[50, 100, 150, 200, 250, 300]}" var="pos">
                                        <line x1="#{pos}" y1="0" x2="#{pos}" y2="320"/>
                                        <line x1="0" y1="#{pos}" x2="320" y2="#{pos}"/>
                                    </ui:repeat>
                                </g>

                                <g fill="#22c55e" fill-opacity="0.4" stroke="#22c55e" stroke-width="2">
                                    <path d="M #{centerX} #{centerY} L #{centerX} #{centerY - (r * scale)} A #{r * scale} #{r * scale} 0 0 1 #{centerX + (r * scale)} #{centerY} Z"/>
                                    <path d="M #{centerX} #{centerY} L #{centerX - (r * scale / 2)} #{centerY} L #{centerX} #{centerY + (r * scale / 2)} Z"/>
                                    <rect x="#{centerX}" y="#{centerY}" width="#{r * scale}" height="#{r * scale / 2}"/>
                                </g>

                                <line x1="0" y1="#{centerY}" x2="320" y2="#{centerY}" stroke="#e5e7eb" stroke-width="2"/>
                                <line x1="#{centerX}" y1="0" x2="#{centerX}" y2="320" stroke="#e5e7eb" stroke-width="2"/>

                                <g stroke="#9ca3af" stroke-width="1.5">
                                    <line x1="#{centerX + (r * scale)}" y1="#{centerY - 5}" x2="#{centerX + (r * scale)}" y2="#{centerY + 5}"/>
                                    <line x1="#{centerX + (r * scale / 2)}" y1="#{centerY - 5}" x2="#{centerX + (r * scale / 2)}" y2="#{centerY + 5}"/>
                                    <line x1="#{centerX - (r * scale / 2)}" y1="#{centerY - 5}" x2="#{centerX - (r * scale / 2)}" y2="#{centerY + 5}"/>
                                    <line x1="#{centerX - (r * scale)}" y1="#{centerY - 5}" x2="#{centerX - (r * scale)}" y2="#{centerY + 5}"/>

                                    <line x1="#{centerX - 5}" y1="#{centerY - (r * scale)}" x2="#{centerX + 5}" y2="#{centerY - (r * scale)}"/>
                                    <line x1="#{centerX - 5}" y1="#{centerY - (r * scale / 2)}" x2="#{centerX + 5}" y2="#{centerY - (r * scale / 2)}"/>
                                    <line x1="#{centerX - 5}" y1="#{centerY + (r * scale / 2)}" x2="#{centerX + 5}" y2="#{centerY + (r * scale / 2)}"/>
                                    <line x1="#{centerX - 5}" y1="#{centerY + (r * scale)}" x2="#{centerX + 5}" y2="#{centerY + (r * scale)}"/>
                                </g>

                                <!-- labels -->
                                <g fill="#9ca3af" font-size="12" text-anchor="middle">
                                    <text x="#{centerX + (r * scale)}" y="#{centerY + 15}">#{r}</text>
                                    <text x="#{centerX + (r * scale / 2)}" y="#{centerY + 15}">#{r/2}</text>
                                    <text x="#{centerX - (r * scale / 2)}" y="#{centerY + 15}">#{-r/2}</text>
                                    <text x="#{centerX - (r * scale)}" y="#{centerY + 15}">#{-r}</text>

                                    <text x="#{centerX - 20}" y="#{centerY - (r * scale) + 5}">#{r}</text>
                                    <text x="#{centerX - 20}" y="#{centerY - (r * scale / 2) + 5}">#{r/2}</text>
                                    <text x="#{centerX - 20}" y="#{centerY + (r * scale / 2) + 5}">#{-r/2}</text>
                                    <text x="#{centerX - 20}" y="#{centerY + (r * scale) + 5}">#{-r}</text>

                                    <text x="#{centerX + 20}" y="15" font-size="14">Y</text>
                                    <text x="305" y="#{centerY + 20}" font-size="14">X</text>
                                </g>

                                <!-- points -->
                                <ui:repeat value="#{resultsManager.results}" var="point">
                                    <circle cx="#{centerX + point.x * scale}"
                                            cy="#{centerY - point.y * scale}"
                                            r="5"
                                            fill="#{point.hit ? '#22c55e' : '#f87171'}"
                                            stroke="#{point.hit ? '#16a34a' : '#dc2626'}"
                                            stroke-width="2"
                                            style="cursor: pointer;">
                                        <title>X: #{point.x}, Y: #{point.y}, R: #{point.r} - #{point.hit ? 'Попадание' : 'Промах'}</title>
                                    </circle>
                                </ui:repeat>
                            </g>

                            <rect x="4" y="4" width="312" height="312" rx="12" ry="12" fill="none" stroke="rgba(255,255,255,0.02)"/>
                        </svg>
                    </h:panelGroup>

                    <h:inputHidden id="graph-x" value="#{resultsManager.graphX}"/>
                    <h:inputHidden id="graph-y" value="#{resultsManager.graphY}"/>
                    <h:inputHidden id="graph-tags" value="#{resultsManager.graphTags}"/>
                    <h:commandButton id="graph-submit" value="Submit Graph" style="display:none;"
                                     action="#{resultsManager.addResultFromGraph()}">
                        <f:ajax execute="graph-x graph-y graph-tags @this" render="@form results-table graph"/>
                    </h:commandButton>
                </div>
            </div>

            <div class="card" style="margin-top: 16px;">
                <h2>Результаты проверок</h2>

                <div style="margin-bottom: 8px; display:flex; gap:8px; align-items:center;">
                    <h:outputLabel for="filter-input" value="Фильтр по тегам:"/>
                    <h:inputText id="filter-input" value="#{resultsManager.filterQuery}" styleClass="form-control" />
                    <h:commandButton value="Применить" action="#{resultsManager.applyFilter()}" styleClass="btn">
                        <f:ajax execute="filter-input" render="results-table graph"/>
                    </h:commandButton>
                    <h:commandButton value="Сброс" action="#{resultsManager.clearFilter()}" styleClass="btn" immediate="true">
                        <f:ajax render="results-table graph"/>
                    </h:commandButton>
                </div>

                <h:panelGroup id="results-table">
                    <h:dataTable value="#{resultsManager.paginatedResults}" var="result"
                                 styleClass="result-table" headerClass="result-header"
                                 rendered="#{not empty resultsManager.results}">
                        <h:column><f:facet name="header">X</f:facet>#{result.x}</h:column>
                        <h:column><f:facet name="header">Y</f:facet>#{result.y}</h:column>
                        <h:column><f:facet name="header">R</f:facet>#{result.r}</h:column>
                        <h:column>
                            <f:facet name="header">Результат</f:facet>
                            <span class="#{result.hit ? 'hit' : 'miss'}">#{result.hit ? 'Попадание' : 'Промах'}</span>
                        </h:column>
                        <h:column>
                            <f:facet name="header">Теги</f:facet>
                            #{result.tagsJoined}
                        </h:column>
                        <h:column><f:facet name="header">Время</f:facet>#{result.formattedServerTime}</h:column>
                        <h:column><f:facet name="header">Время выполнения</f:facet>#{result.execTimeNs} нс</h:column>
                    </h:dataTable>

                    <div class="pagination" rendered="#{resultsManager.totalPages > 1}">
                        <h:commandButton value="←"
                                         action="#{resultsManager.previousPage()}"
                                         disabled="#{resultsManager.currentPage == 0}"
                                         styleClass="btn pagination-btn">
                            <f:ajax render="results-table" execute="@this"/>
                        </h:commandButton>

                        <span class="pagination-info">
                            Страница #{resultsManager.currentPage + 1} из #{resultsManager.totalPages}
                            (всего: #{resultsManager.results.size()} результатов)
                        </span>

                        <h:commandButton value="→"
                                         action="#{resultsManager.nextPage()}"
                                         disabled="#{resultsManager.currentPage >= resultsManager.totalPages - 1}"
                                         styleClass="btn pagination-btn">
                            <f:ajax render="results-table" execute="@this"/>
                        </h:commandButton>
                    </div>

                </h:panelGroup>
            </div>

            <div style="text-align: center; margin-top: 16px;">
                <h:commandButton value="← Вернуться на стартовую страницу"
                                 action="to-index"
                                 styleClass="btn"
                                 immediate="true"/>
            </div>
        </h:form>
    </div>
</h:body>
</html>